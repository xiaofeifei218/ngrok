# Docker 端口配置详解

## 🤔 为什么有两组端口配置？

在 `.env.example` 文件中，您会看到两组看起来相似的端口配置。让我用图解来说明它们的区别：

## 📊 端口配置图解

```
┌─────────────────────────────────────────────────────────────────┐
│                         您的电脑 (主机)                           │
│                                                                   │
│  客户端访问这些端口                                                │
│  ↓                                                                │
│  主机端口:                                                         │
│  - 80          ←─── 外部访问 HTTP                                 │
│  - 443         ←─── 外部访问 HTTPS                                │
│  - 4443        ←─── ngrok 客户端连接                              │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Docker 容器 (ngrokd)                          │  │
│  │                                                            │  │
│  │  容器内端口:                                                │  │
│  │  - :80      ←─── ngrokd 进程监听 HTTP                      │  │
│  │  - :443     ←─── ngrokd 进程监听 HTTPS                     │  │
│  │  - :4443    ←─── ngrokd 进程监听客户端连接                  │  │
│  │                                                            │  │
│  │  端口映射关系:                                              │  │
│  │  主机:80    ──→  容器:80                                    │  │
│  │  主机:443   ──→  容器:443                                   │  │
│  │  主机:4443  ──→  容器:4443                                  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 📝 配置说明

### 第一组：容器内部监听地址

```bash
# 这些是 ngrokd 程序在容器内部监听的地址
HTTP_ADDR=:80        # ngrokd 在容器内监听 80 端口
HTTPS_ADDR=:443      # ngrokd 在容器内监听 443 端口
TUNNEL_ADDR=:4443    # ngrokd 在容器内监听 4443 端口
```

**作用**: 告诉 ngrokd 程序应该在哪个端口上监听
**传递给**: docker-entrypoint.sh → ngrokd 程序
**通常不需要修改**（除非您有特殊需求）

### 第二组：主机端口映射

```bash
# 这些是主机（您的电脑）上暴露的端口
HTTP_PORT=80         # 主机的 80 端口映射到容器的 80 端口
HTTPS_PORT=443       # 主机的 443 端口映射到容器的 443 端口
TUNNEL_PORT=4443     # 主机的 4443 端口映射到容器的 4443 端口
```

**作用**: 定义外部如何访问容器
**使用场景**: 当主机端口被占用时，可以修改这些值
**常见修改**: 开发环境避免使用特权端口 (80/443)

## 💡 实际使用示例

### 示例 1: 生产环境（默认配置）

```bash
# .env 配置
DOMAIN=ngrok.example.com
HTTP_ADDR=:80          # 容器内监听 80
HTTPS_ADDR=:443        # 容器内监听 443
TUNNEL_ADDR=:4443      # 容器内监听 4443

# docker-compose.yml 端口映射
ports:
  - "80:80"      # 主机80 → 容器80
  - "443:443"    # 主机443 → 容器443
  - "4443:4443"  # 主机4443 → 容器4443
```

**访问方式**:
- HTTP 隧道: `http://your-domain.com` (端口 80)
- HTTPS 隧道: `https://your-domain.com` (端口 443)
- 客户端连接: `your-domain.com:4443`

### 示例 2: 开发环境（避免端口冲突）

如果您的电脑上 80 和 443 端口已被占用（比如本地有其他 Web 服务）：

```bash
# .env 配置
DOMAIN=ngrok.me
HTTP_ADDR=:80          # 容器内还是监听 80（容器内部不冲突）
HTTPS_ADDR=:443        # 容器内还是监听 443
TUNNEL_ADDR=:4443      # 容器内还是监听 4443

# docker-compose.yml 端口映射修改为:
ports:
  - "8080:80"     # 主机8080 → 容器80
  - "8443:443"    # 主机8443 → 容器443
  - "4443:4443"   # 主机4443 → 容器4443
```

**访问方式**:
- HTTP 隧道: `http://ngrok.me:8080`
- HTTPS 隧道: `https://ngrok.me:8443`
- 客户端连接: `ngrok.me:4443`

### 示例 3: 只修改主机端口

```bash
# .env 配置（容器内部不变）
HTTP_ADDR=:80
HTTPS_ADDR=:443
TUNNEL_ADDR=:4443

# docker-compose.yml 修改主机端口
ports:
  - "18080:80"    # 主机18080 → 容器80
  - "18443:443"   # 主机18443 → 容器443
  - "14443:4443"  # 主机14443 → 容器4443
```

**访问方式**:
- HTTP 隧道: `http://your-domain.com:18080`
- HTTPS 隧道: `https://your-domain.com:18443`
- 客户端连接: `your-domain.com:14443`

## ❓ 常见问题

### Q1: 什么时候需要修改容器内部端口 (HTTP_ADDR, HTTPS_ADDR)?

**A**: 几乎不需要！除非：
- 您想在容器内使用非标准端口
- 有特殊的网络配置需求

**不推荐修改**，保持默认值 `:80`, `:443`, `:4443` 即可。

### Q2: 什么时候需要修改主机端口映射?

**A**: 常见情况：
- ✅ 主机的 80/443 端口已被其他程序占用
- ✅ 开发环境不想使用 root 权限运行（80/443 需要特权）
- ✅ 在同一台机器上运行多个 ngrokd 实例
- ✅ 安全原因，不想暴露标准端口

### Q3: 如何修改主机端口？

**方法 1**: 直接编辑 `docker-compose.yml`

```yaml
ports:
  - "8080:80"    # 改左边的数字（主机端口）
  - "8443:443"   # 右边的数字保持不变（容器端口）
  - "4443:4443"
```

**方法 2**: 使用环境变量（需要修改 docker-compose.yml 支持）

```yaml
ports:
  - "${HTTP_PORT:-80}:80"
  - "${HTTPS_PORT:-443}:443"
  - "${TUNNEL_PORT:-4443}:4443"
```

### Q4: 端口冲突怎么办？

**错误信息**: `bind: address already in use`

**解决方案**:

```bash
# 1. 查看哪个进程占用了端口
sudo lsof -i :80
sudo lsof -i :443

# 2. 修改 docker-compose.yml 使用其他主机端口
ports:
  - "8080:80"
  - "8443:443"
  - "4443:4443"
```

### Q5: 为什么我的配置在 .env.example 中没有被使用？

**A**: 注意看当前的 `docker-compose.yml`，端口映射是硬编码的：

```yaml
ports:
  - "4443:4443"  # 硬编码
  - "80:80"      # 硬编码
  - "443:443"    # 硬编码
```

如果您想使用 `.env` 文件中的变量，需要修改为：

```yaml
ports:
  - "${TUNNEL_PORT:-4443}:4443"
  - "${HTTP_PORT:-80}:80"
  - "${HTTPS_PORT:-443}:443"
```

## 🎯 推荐配置

### 生产环境

```bash
# .env
DOMAIN=your-domain.com
HTTP_ADDR=:80
HTTPS_ADDR=:443
TUNNEL_ADDR=:4443

# docker-compose.yml (保持默认)
ports:
  - "80:80"
  - "443:443"
  - "4443:4443"
```

### 开发环境（推荐使用 docker-compose.dev.yml）

已经为您配置好了！直接使用：

```bash
./quick-start.sh dev
```

它会使用：
```yaml
ports:
  - "8080:80"    # 避免权限问题
  - "8443:443"   # 避免权限问题
  - "4443:4443"
```

## 📚 端口映射格式说明

Docker 端口映射格式: `"主机端口:容器端口"`

```yaml
ports:
  - "8080:80"
     ↑     ↑
     |     └─ 容器内部的端口 (ngrokd 监听的端口)
     └─────── 主机对外暴露的端口 (外部访问的端口)
```

**举例**:
- `"80:80"`: 主机 80 映射到容器 80（直通）
- `"8080:80"`: 主机 8080 映射到容器 80（端口转换）
- `"18080:80"`: 主机 18080 映射到容器 80（自定义端口）

## 🔧 实用命令

```bash
# 查看容器端口映射
docker port ngrokd

# 查看主机端口占用情况
sudo lsof -i :80
sudo lsof -i :443
sudo lsof -i :4443

# 测试端口连通性
nc -zv localhost 4443
curl http://localhost:8080
```

## 总结

| 配置项 | 位置 | 作用 | 修改频率 |
|--------|------|------|----------|
| `HTTP_ADDR` | 容器内 | ngrokd 监听地址 | ⭐ 很少 |
| `HTTPS_ADDR` | 容器内 | ngrokd 监听地址 | ⭐ 很少 |
| `TUNNEL_ADDR` | 容器内 | ngrokd 监听地址 | ⭐ 很少 |
| 主机端口映射 | docker-compose.yml | 外部访问入口 | ⭐⭐⭐ 经常 |

**记住**:
- 容器内部端口（HTTP_ADDR 等）通常不需要改
- 主机端口映射（docker-compose.yml 的 ports）根据需要调整
- 开发环境推荐使用 8080/8443 避免权限问题
